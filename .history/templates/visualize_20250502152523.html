<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Deployment Visualizations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .chart-container {
            height: 600px;
            margin-bottom: 30px;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .nav-pills .nav-link {
            color: #495057;
        }
        .nav-pills .nav-link.active {
            color: #fff;
            background-color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h1>Account Deployment Visualizations</h1>
                <p>Explore resource deployment across accounts and technology areas</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/" class="btn btn-outline-primary">Back to Dashboard</a>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-pills mb-4" id="vizTabs">
            <li class="nav-item">
                <a class="nav-link active" id="overview-tab" data-bs-toggle="pill" href="#overview">Overview</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="accounts-tab" data-bs-toggle="pill" href="#accounts">Account Analysis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tech-tab" data-bs-toggle="pill" href="#tech">Technology Analysis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="roles-tab" data-bs-toggle="pill" href="#roles">Role Analysis</a>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Top 15 Accounts by Total Deployment</h5>
                            </div>
                            <div class="card-body">
                                <div id="topAccountsChart" class="chart-container">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Overall Technology Distribution</h5>
                            </div>
                            <div class="card-body">
                                <div id="techPieChart" class="chart-container">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Summary Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h3 id="totalAccounts">-</h3>
                                                <p class="mb-0">Total Accounts</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h3 id="totalPeople">-</h3>
                                                <p class="mb-0">Total People Deployed</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h3 id="avgPerAccount">-</h3>
                                                <p class="mb-0">Avg. Per Account</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h3 id="topAccount">-</h3>
                                                <p class="mb-0">Largest Account</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Account Analysis Tab -->
            <div class="tab-pane fade" id="accounts">
                <div class="filter-section mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="accountSelect" class="form-label">Select Account</label>
                            <select id="accountSelect" class="form-select">
                                <option value="">Select an account...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="clientTypeSelect" class="form-label">Client Type</label>
                            <select id="clientTypeSelect" class="form-select">
                                <option value="">All Client Types</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary mt-4" onclick="loadAccountAnalysis()">Analyze</button>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Technology Breakdown</h5>
                            </div>
                            <div class="card-body">
                                <div id="accountTechBreakdown" class="chart-container">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <p class="text-muted">Select an account to view its technology breakdown</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Role Distribution</h5>
                            </div>
                            <div class="card-body">
                                <div id="accountRoleBreakdown" class="chart-container">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <p class="text-muted">Select an account to view its role distribution</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Technology Analysis Tab -->
            <div class="tab-pane fade" id="tech">
                <div class="filter-section mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="techSelect" class="form-label">Technology Area</label>
                            <select id="techSelect" class="form-select">
                                <option value="">Select a technology area...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="comparisonTypeSelect" class="form-label">Comparison Type</label>
                            <select id="comparisonTypeSelect" class="form-select">
                                <option value="accounts">By Accounts</option>
                                <option value="roles">By Roles</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary mt-4" onclick="loadTechAnalysis()">Analyze</button>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0" id="techChartTitle">Technology Distribution</h5>
                            </div>
                            <div class="card-body">
                                <div id="techAnalysisChart" class="chart-container">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <p class="text-muted">Select a technology area to analyze</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Role Analysis Tab -->
            <div class="tab-pane fade" id="roles">
                <div class="filter-section mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="roleSelect" class="form-label">Role</label>
                            <select id="roleSelect" class="form-select">
                                <option value="">Select a role...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="roleCategorySelect" class="form-label">Role Category</label>
                            <select id="roleCategorySelect" class="form-select">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary mt-4" onclick="loadRoleAnalysis()">Analyze</button>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0" id="roleChartTitle">Role Distribution</h5>
                            </div>
                            <div class="card-body">
                                <div id="roleAnalysisChart" class="chart-container">
                                    <div class="d-flex justify-content-center align-items-center h-100">
                                        <p class="text-muted">Select a role to analyze</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Data cache
        let fullData = [];
        let filterOptions = {};
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadFilters();
            loadOverviewData();
            setupTabListeners();
        });
        
        // Set up tab change listeners
        function setupTabListeners() {
            const tabs = document.querySelectorAll('#vizTabs .nav-link');
            tabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Deactivate all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    // Activate clicked tab
                    this.classList.add('active');
                    
                    // Hide all tab panes
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    
                    // Show selected tab pane
                    const targetId = this.getAttribute('href').substring(1);
                    const targetPane = document.getElementById(targetId);
                    targetPane.classList.add('show', 'active');
                });
            });
        }
        
        // Load filter options
        function loadFilters() {
            axios.get('/api/filters')
                .then(response => {
                    filterOptions = response.data;
                    
                    // Account filters
                    const accountSelect = document.getElementById('accountSelect');
                    filterOptions.accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account;
                        option.textContent = account;
                        accountSelect.appendChild(option);
                    });
                    
                    // Technology filters
                    const techSelect = document.getElementById('techSelect');
                    filterOptions.technologies.forEach(tech => {
                        const option = document.createElement('option');
                        option.value = tech;
                        option.textContent = tech;
                        techSelect.appendChild(option);
                    });
                    
                    // Role filters
                    const roleSelect = document.getElementById('roleSelect');
                    filterOptions.roles.forEach(role => {
                        if (role && role.trim() !== "") {
                            const option = document.createElement('option');
                            option.value = role;
                            option.textContent = role;
                            roleSelect.appendChild(option);
                        }
                    });
                    
                    // Role category filters
                    const roleCategorySelect = document.getElementById('roleCategorySelect');
                    filterOptions.role_categories.forEach(category => {
                        if (category && category.trim() !== "") {
                            const option = document.createElement('option');
                            option.value = category;
                            option.textContent = category;
                            roleCategorySelect.appendChild(option);
                        }
                    });
                    
                    // Client type filters (unique values from full data)
                    axios.get('/api/data')
                        .then(response => {
                            fullData = response.data;
                            
                            // Extract unique client types
                            const clientTypes = [...new Set(fullData
                                .map(item => item.client_type)
                                .filter(type => type && type.trim() !== ""))];
                            
                            const clientTypeSelect = document.getElementById('clientTypeSelect');
                            clientTypes.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type;
                                option.textContent = type;
                                clientTypeSelect.appendChild(option);
                            });
                        })
                        .catch(error => {
                            console.error('Error loading data:', error);
                        });
                })
                .catch(error => {
                    console.error('Error loading filters:', error);
                });
        }
        
        // Load overview data
        function loadOverviewData() {
            // Load accounts bar chart
            axios.get('/api/visualize/accounts')
                .then(response => {
                    Plotly.newPlot('topAccountsChart', response.data.data, response.data.layout);
                })
                .catch(error => {
                    console.error('Error loading accounts chart:', error);
                    document.getElementById('topAccountsChart').innerHTML = 
                        '<div class="alert alert-danger">Error loading chart. Please check the console for details.</div>';
                });
                
            // Load tech pie chart (custom endpoint)
            axios.get('/api/data')
                .then(response => {
                    const data = response.data;
                    
                    // Calculate tech breakdown
                    const techCounts = {};
                    data.forEach(item => {
                        const tech = item.technology_area;
                        techCounts[tech] = (techCounts[tech] || 0) + 1;
                    });
                    
                    // Create pie chart
                    const techPie = {
                        data: [{
                            type: 'pie',
                            labels: Object.keys(techCounts),
                            values: Object.values(techCounts),
                            textinfo: 'label+percent',
                            insidetextorientation: 'radial'
                        }],
                        layout: {
                            title: 'Technology Distribution',
                            height: 500
                        }
                    };
                    
                    Plotly.newPlot('techPieChart', techPie.data, techPie.layout);
                    
                    // Update summary stats
                    const totalAccounts = [...new Set(data.map(item => item.account))].length;
                    const totalPeople = data.length;
                    const avgPerAccount = (totalPeople / totalAccounts).toFixed(1);
                    
                    // Find the largest account
                    const accountCounts = {};
                    data.forEach(item => {
                        accountCounts[item.account] = (accountCounts[item.account] || 0) + 1;
                    });
                    
                    const largestAccount = Object.entries(accountCounts)
                        .sort((a, b) => b[1] - a[1])[0];
                    
                    // Update stats display
                    document.getElementById('totalAccounts').textContent = totalAccounts;
                    document.getElementById('totalPeople').textContent = totalPeople;
                    document.getElementById('avgPerAccount').textContent = avgPerAccount;
                    document.getElementById('topAccount').textContent = largestAccount ? 
                        `${largestAccount[0]} (${largestAccount[1]})` : '-';
                })
                .catch(error => {
                    console.error('Error creating tech pie chart:', error);
                    document.getElementById('techPieChart').innerHTML = 
                        '<div class="alert alert-danger">Error loading chart. Please check the console for details.</div>';
                });
        }
        
        // Load account analysis charts
        function loadAccountAnalysis() {
            const account = document.getElementById('accountSelect').value;
            const clientType = document.getElementById('clientTypeSelect').value;
            
            if (!account) {
                alert('Please select an account to analyze');
                return;
            }
            
            let filteredData = fullData.filter(item => item.account === account);
            
            if (clientType) {
                filteredData = filteredData.filter(item => item.client_type === clientType);
            }
            
            if (filteredData.length === 0) {
                document.getElementById('accountTechBreakdown').innerHTML = 
                    '<div class="alert alert-warning">No data found for the selected filters.</div>';
                document.getElementById('accountRoleBreakdown').innerHTML = 
                    '<div class="alert alert-warning">No data found for the selected filters.</div>';
                return;
            }
            
            // Create tech breakdown chart
            const techCounts = {};
            filteredData.forEach(item => {
                const tech = item.technology_area;
                techCounts[tech] = (techCounts[tech] || 0) + 1;
            });
            
            const techPie = {
                data: [{
                    type: 'pie',
                    labels: Object.keys(techCounts),
                    values: Object.values(techCounts),
                    textinfo: 'label+percent',
                    insidetextorientation: 'radial'
                }],
                layout: {
                    title: `Technology Distribution for ${account}`,
                    height: 500
                }
            };
            
            Plotly.newPlot('accountTechBreakdown', techPie.data, techPie.layout);
            
            // Create role breakdown chart
            const roleCounts = {};
            filteredData.forEach(item => {
                const role = item.role || 'Unspecified';
                roleCounts[role] = (roleCounts[role] || 0) + 1;
            });
            
            // Sort roles by count
            const sortedRoles = Object.entries(roleCounts)
                .sort((a, b) => b[1] - a[1]);
            
            const roleBar = {
                data: [{
                    type: 'bar',
                    x: sortedRoles.map(item => item[0]),
                    y: sortedRoles.map(item => item[1]),
                    marker: {
                        color: 'rgba(55, 128, 191, 0.7)'
                    }
                }],
                layout: {
                    title: `Role Distribution for ${account}`,
                    height: 500,
                    xaxis: {
                        tickangle: -45
                    },
                    yaxis: {
                        title: 'Number of People'
                    },
                    margin: {
                        b: 150
                    }
                }
            };
            
            Plotly.newPlot('accountRoleBreakdown', roleBar.data, roleBar.layout);
        }
        
        // Load technology analysis charts
        function loadTechAnalysis() {
            const tech = document.getElementById('techSelect').value;
            const comparisonType = document.getElementById('comparisonTypeSelect').value;
            
            if (!tech) {
                alert('Please select a technology area to analyze');
                return;
            }
            
            const filteredData = fullData.filter(item => item.technology_area === tech);
            
            if (filteredData.length === 0) {
                document.getElementById('techAnalysisChart').innerHTML = 
                    '<div class="alert alert-warning">No data found for the selected technology area.</div>';
                return;
            }
            
            if (comparisonType === 'accounts') {
                // By accounts analysis
                const accountCounts = {};
                filteredData.forEach(item => {
                    accountCounts[item.account] = (accountCounts[item.account] || 0) + 1;
                });
                
                // Sort accounts by count
                const sortedAccounts = Object.entries(accountCounts)
                    .sort((a, b) => b[1] - a[1]);
                
                // Limit to top 15 for readability
                const topAccounts = sortedAccounts.slice(0, 15);
                
                const accountBar = {
                    data: [{
                        type: 'bar',
                        x: topAccounts.map(item => item[0]),
                        y: topAccounts.map(item => item[1]),
                        marker: {
                            color: 'rgba(50, 171, 96, 0.7)'
                        }
                    }],
                    layout: {
                        title: `Top Accounts Using ${tech}`,
                        height: 500,
                        xaxis: {
                            tickangle: -45
                        },
                        yaxis: {
                            title: 'Number of People'
                        },
                        margin: {
                            b: 150
                        }
                    }
                };
                
                document.getElementById('techChartTitle').textContent = `Top Accounts Using ${tech}`;
                Plotly.newPlot('techAnalysisChart', accountBar.data, accountBar.layout);
                
            } else {
                // By roles analysis
                const roleCounts = {};
                filteredData.forEach(item => {
                    const role = item.role || 'Unspecified';
                    roleCounts[role] = (roleCounts[role] || 0) + 1;
                });
                
                // Sort roles by count
                const sortedRoles = Object.entries(roleCounts)
                    .sort((a, b) => b[1] - a[1]);
                
                const roleBar = {
                    data: [{
                        type: 'bar',
                        x: sortedRoles.map(item => item[0]),
                        y: sortedRoles.map(item => item[1]),
                        marker: {
                            color: 'rgba(142, 124, 195, 0.7)'
                        }
                    }],
                    layout: {
                        title: `Roles in ${tech}`,
                        height: 500,
                        xaxis: {
                            tickangle: -45
                        },
                        yaxis: {
                            title: 'Number of People'
                        },
                        margin: {
                            b: 150
                        }
                    }
                };
                
                document.getElementById('techChartTitle').textContent = `Roles in ${tech}`;
                Plotly.newPlot('techAnalysisChart', roleBar.data, roleBar.layout);
            }
        }
        
        // Load role analysis chart
        function loadRoleAnalysis() {
            const role = document.getElementById('roleSelect').value;
            const category = document.getElementById('roleCategorySelect').value;
            
            let filteredData = fullData;
            let title = 'Role Distribution';
            
            if (role) {
                filteredData = filteredData.filter(item => item.role === role);
                title = `Accounts Using Role: ${role}`;
            } else if (category) {
                filteredData = filteredData.filter(item => item.role_category === category);
                title = `Accounts Using Role Category: ${category}`;
            } else {
                alert('Please select a role or role category to analyze');
                return;
            }
            
            if (filteredData.length === 0) {
                document.getElementById('roleAnalysisChart').innerHTML = 
                    '<div class="alert alert-warning">No data found for the selected role filters.</div>';
                return;
            }
            
            // Analyze by account
            const accountCounts = {};
            filteredData.forEach(item => {
                accountCounts[item.account] = (accountCounts[item.account] || 0) + 1;
            });
            
            // Sort accounts by count
            const sortedAccounts = Object.entries(accountCounts)
                .sort((a, b) => b[1] - a[1]);
            
            // Limit to top 15 for readability
            const topAccounts = sortedAccounts.slice(0, 15);
            
            const accountBar = {
                data: [{
                    type: 'bar',
                    x: topAccounts.map(item => item[0]),
                    y: topAccounts.map(item => item[1]),
                    marker: {
                        color: 'rgba(214, 39, 40, 0.7)'
                    }
                }],
                layout: {
                    title: title,
                    height: 500,
                    xaxis: {
                        tickangle: -45
                    },
                    yaxis: {
                        title: 'Number of People'
                    },
                    margin: {
                        b: 150
                    }
                }
            };
            
            document.getElementById('roleChartTitle').textContent = title;
            Plotly.newPlot('roleAnalysisChart', accountBar.data, accountBar.layout);
        }
    </script>
</body>
</html>